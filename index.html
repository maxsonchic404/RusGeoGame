<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –†–æ—Å—Å–∏–∏ - –†–µ–≥–∏–æ–Ω—ã –†–§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            width: 100%;
        }

        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è */
        .level-selector {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-selector h1 {
            font-size: 36px;
            color: #1d1d1f;
            margin-bottom: 15px;
        }

        .level-selector p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .level-card:active {
            transform: translateY(-2px);
        }

        .level-card.level-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .level-card.level-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .level-card.level-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .level-card.level-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .level-card.level-5 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            grid-column: 1 / -1;
        }

        .level-number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .level-desc {
            font-size: 14px;
            opacity: 0.9;
        }

        .game-container {
            display: none;
        }

        .game-container.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #007AFF;
            color: white;
            transition: all 0.3s;
            font-weight: 500;
        }

        button:hover {
            background: #0051D5;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #studyMode {
            background: #FF9500;
        }

        #studyMode.active {
            background: #34C759;
        }

        #resetBtn {
            background: #FF3B30;
        }

        #backToLevels {
            background: #5856D6;
        }

        #resetZoom {
            background: #8E8E93;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #zoomIn, #zoomOut {
            padding: 10px 18px;
            font-size: 20px;
            font-weight: bold;
            background: #8E8E93;
            min-width: 45px;
        }

        .info-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .region-display {
            background: white;
            border: 2px solid #007AFF;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .region-info {
            background: white;
            border: 2px solid #FF9500;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .region-info.visible {
            display: block;
        }

        .region-name {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
            min-height: 32px;
        }

        .region-capital {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .attempts {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .map-container {
            background: white;
            border: 4px solid #d1d1d6;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s, transform 0.1s;
        }

        .map-container.correct {
            border-color: #34C759;
        }

        .map-container.incorrect {
            border-color: #FF3B30;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        #map {
            width: 100%;
            height: 700px;
            cursor: grab;
        }

        #map:active {
            cursor: grabbing;
        }

        .region-path {
            stroke: #1d1d1f;
            stroke-width: 0.5;
            cursor: pointer;
            transition: opacity 0.3s, fill 0.3s;
        }

        .region-path:hover {
            opacity: 0.8;
            stroke-width: 1.5;
        }

        /* –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã (–¥–ª—è —É—Ä–æ–≤–Ω–µ–π 1-4) */
        .region-path.inactive {
            fill: #e8e8ed !important;
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .region-path.inactive:hover {
            opacity: 0.4;
            stroke-width: 0.5;
        }

        .region-path.guessed {
            fill: #f0f0f0 !important;
            cursor: default;
            opacity: 0.5;
        }

        .region-path.missed {
            fill: #FFD700 !important;
            stroke-width: 2;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .region-path.studying {
            opacity: 0.8;
            stroke-width: 2;
        }

        .stats {
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            color: #1d1d1f;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .zoom-info {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feedback-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px 60px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .feedback-notification.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .feedback-notification.correct {
            background: linear-gradient(135deg, #34C759 0%, #2FA84E 100%);
            color: white;
        }

        .feedback-notification.incorrect {
            background: linear-gradient(135deg, #FF3B30 0%, #D32F2F 100%);
            color: white;
        }

        .feedback-icon {
            font-size: 80px;
            margin-bottom: 10px;
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .feedback-text {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
        }

        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .screen-flash.correct {
            background: rgba(52, 199, 89, 0.3);
        }

        .screen-flash.incorrect {
            background: rgba(255, 59, 48, 0.3);
        }

        .screen-flash.show {
            opacity: 1;
        }

        .final-summary {
            background: white;
            border: 3px solid #007AFF;
            border-radius: 16px;
            padding: 30px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .final-summary h2 {
            font-size: 32px;
            color: #1d1d1f;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            padding: 20px;
            border-radius: 12px;
            background: #f5f5f7;
        }

        .stat-item.correct-stat {
            background: linear-gradient(135deg, #d4f4dd 0%, #a3e4c8 100%);
        }

        .stat-item.missed-stat {
            background: linear-gradient(135deg, #fff4cc 0%, #ffe999 100%);
        }

        .stat-item.total-stat {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #1d1d1f;
        }

        .stat-label {
            font-size: 16px;
            color: #666;
            margin-top: 5px;
        }

        .percentage {
            font-size: 20px;
            font-weight: 600;
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .percentage.excellent {
            color: #34C759;
        }

        .percentage.good {
            color: #FF9500;
        }

        .percentage.needwork {
            color: #FF3B30;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .level-selector {
                padding: 25px 20px;
            }

            .level-selector h1 {
                font-size: 28px;
            }

            .level-selector p {
                font-size: 16px;
                margin-bottom: 20px;
            }

            .levels-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .level-card {
                padding: 25px 20px;
                min-height: 160px;
            }

            .level-card.level-5 {
                grid-column: 1;
            }

            .level-number {
                font-size: 40px;
            }

            .level-title {
                font-size: 20px;
            }

            .level-desc {
                font-size: 13px;
            }

            .controls {
                gap: 8px;
                margin-bottom: 12px;
            }

            button {
                padding: 10px 16px;
                font-size: 14px;
            }

            #zoomIn, #zoomOut {
                padding: 8px 14px;
                font-size: 18px;
                min-width: 40px;
            }

            .info-panels {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .region-display, .region-info {
                padding: 15px;
            }

            .region-name {
                font-size: 18px;
            }

            .region-capital {
                font-size: 15px;
            }

            .map-container {
                padding: 10px;
            }

            #map {
                height: 450px;
            }

            .zoom-info {
                font-size: 11px;
                padding: 8px 12px;
                top: 15px;
                right: 15px;
            }

            .feedback-notification {
                padding: 30px 40px;
            }

            .feedback-icon {
                font-size: 60px;
            }

            .feedback-text {
                font-size: 24px;
            }

            .final-summary {
                padding: 20px;
            }

            .final-summary h2 {
                font-size: 24px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-number {
                font-size: 36px;
            }

            .stat-label {
                font-size: 14px;
            }

            .percentage {
                font-size: 18px;
            }
        }

        @media (hover: none) {
            button:hover {
                transform: none;
                background: initial;
            }

            .region-path:hover {
                opacity: initial;
                stroke-width: 0.5;
            }

            .level-card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="screen-flash" id="screenFlash"></div>

    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è -->
        <div class="level-selector" id="levelSelector">
            <h1>üó∫Ô∏è –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –†–æ—Å—Å–∏–∏</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</p>
            
            <div class="levels-grid">
                <div class="level-card level-1" onclick="selectLevel(1)">
                    <div class="level-number">1</div>
                    <div class="level-title">–ó–∞–ø–∞–¥</div>
                    <div class="level-desc">–ó–∞–ø–∞–¥–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏</div>
                </div>
                
                <div class="level-card level-2" onclick="selectLevel(2)">
                    <div class="level-number">2</div>
                    <div class="level-title">–í–æ—Å—Ç–æ–∫</div>
                    <div class="level-desc">–í–æ—Å—Ç–æ—á–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏</div>
                </div>
                
                <div class="level-card level-3" onclick="selectLevel(3)">
                    <div class="level-number">3</div>
                    <div class="level-title">–°–µ–≤–µ—Ä</div>
                    <div class="level-desc">–°–µ–≤–µ—Ä–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏</div>
                </div>
                
                <div class="level-card level-4" onclick="selectLevel(4)">
                    <div class="level-number">4</div>
                    <div class="level-title">–Æ–≥</div>
                    <div class="level-desc">–Æ–∂–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏</div>
                </div>
                
                <div class="level-card level-5" onclick="selectLevel(5)">
                    <div class="level-number">5</div>
                    <div class="level-title">–í–°–Ø –†–û–°–°–ò–Ø</div>
                    <div class="level-desc">–í—Å–µ 89 —Ä–µ–≥–∏–æ–Ω–æ–≤ - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤!</div>
                </div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
        <div class="game-container" id="gameContainer">
            <div class="controls">
                <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
                <button id="studyMode">–†–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è</button>
                <div class="zoom-controls">
                    <button id="zoomOut">‚àí</button>
                    <button id="zoomIn">+</button>
                </div>
                <button id="resetZoom">–°–±—Ä–æ—Å –≤–∏–¥–∞</button>
                <button id="backToLevels">‚Üê –ö —É—Ä–æ–≤–Ω—è–º</button>
            </div>

            <div class="info-panels">
                <div class="region-display">
                    <div class="region-name" id="regionName">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å" –¥–ª—è –∏–≥—Ä—ã</div>
                    <div class="attempts" id="attempts"></div>
                </div>

                <div class="region-info" id="regionInfo">
                    <div class="info-label">–ò–∑—É—á–∞–µ–º—ã–π —Ä–µ–≥–∏–æ–Ω</div>
                    <div class="region-name" id="studyRegionName">‚Äî</div>
                    <div class="region-capital" id="studyRegionCapital">‚Äî</div>
                </div>
            </div>

            <div class="map-container" id="mapContainer">
                <div id="map" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –†–æ—Å—Å–∏–∏...</div>
                
                <div class="feedback-notification" id="feedbackNotification">
                    <div class="feedback-icon" id="feedbackIcon"></div>
                    <div class="feedback-text" id="feedbackText"></div>
                </div>
                
                <div class="zoom-info">
                    <div>‚úã –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</div>
                    <div>+ / ‚àí - –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ/–æ—Ç–¥–∞–ª–µ–Ω–∏–µ</div>
                </div>
            </div>

            <div class="stats" id="stats"></div>
            <div id="finalSummary"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    
    <script>
        const regionCapitals = {
            '–ê–¥—ã–≥–µ—è': '–ú–∞–π–∫–æ–ø', '–ê–ª—Ç–∞–π': '–ì–æ—Ä–Ω–æ-–ê–ª—Ç–∞–π—Å–∫', '–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω': '–£—Ñ–∞',
            '–ë—É—Ä—è—Ç–∏—è': '–£–ª–∞–Ω-–£–¥—ç', '–î–∞–≥–µ—Å—Ç–∞–Ω': '–ú–∞—Ö–∞—á–∫–∞–ª–∞', '–ò–Ω–≥—É—à–µ—Ç–∏—è': '–ú–∞–≥–∞—Å',
            '–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä–∏—è': '–ù–∞–ª—å—á–∏–∫', '–ö–∞–ª–º—ã–∫–∏—è': '–≠–ª–∏—Å—Ç–∞',
            '–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è': '–ß–µ—Ä–∫–µ—Å—Å–∫', '–ö–∞—Ä–µ–ª–∏—è': '–ü–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫',
            '–ö–æ–º–∏': '–°—ã–∫—Ç—ã–≤–∫–∞—Ä', '–ú–∞—Ä–∏–π –≠–ª': '–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ú–æ—Ä–¥–æ–≤–∏—è': '–°–∞—Ä–∞–Ω—Å–∫',
            '–°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)': '–Ø–∫—É—Ç—Å–∫', '–°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è': '–í–ª–∞–¥–∏–∫–∞–≤–∫–∞–∑',
            '–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω': '–ö–∞–∑–∞–Ω—å', '–¢—ã–≤–∞': '–ö—ã–∑—ã–ª', '–£–¥–º—É—Ä—Ç–∏—è': '–ò–∂–µ–≤—Å–∫',
            '–•–∞–∫–∞—Å–∏—è': '–ê–±–∞–∫–∞–Ω', '–ß–µ—á–Ω—è': '–ì—Ä–æ–∑–Ω—ã–π', '–ß—É–≤–∞—à–∏—è': '–ß–µ–±–æ–∫—Å–∞—Ä—ã',
            '–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π': '–ë–∞—Ä–Ω–∞—É–ª', '–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π': '–ß–∏—Ç–∞',
            '–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π': '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π': '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',
            '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π': '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π': '–ü–µ—Ä–º—å',
            '–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π': '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π': '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å',
            '–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π': '–•–∞–±–∞—Ä–æ–≤—Å–∫', '–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ë–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫',
            '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫', '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å',
            '–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ë–µ–ª–≥–æ—Ä–æ–¥', '–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ë—Ä—è–Ω—Å–∫',
            '–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–í–ª–∞–¥–∏–º–∏—Ä', '–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–í–æ–ª–≥–æ–≥—Ä–∞–¥',
            '–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–í–æ–ª–æ–≥–¥–∞', '–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–í–æ—Ä–æ–Ω–µ–∂',
            '–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ò–≤–∞–Ω–æ–≤–æ', '–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ò—Ä–∫—É—Ç—Å–∫',
            '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö–∞–ª—É–≥–∞',
            '–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö–µ–º–µ—Ä–æ–≤–æ', '–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö–∏—Ä–æ–≤',
            '–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö–æ—Å—Ç—Ä–æ–º–∞', '–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö—É—Ä–≥–∞–Ω',
            '–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ö—É—Ä—Å–∫', '–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ì–∞—Ç—á–∏–Ω–∞',
            '–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–õ–∏–ø–µ—Ü–∫', '–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ú–∞–≥–∞–¥–∞–Ω',
            '–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ú–æ—Å–∫–≤–∞', '–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ú—É—Ä–º–∞–Ω—Å–∫',
            '–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
            '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–û–º—Å–∫',
            '–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–û—Ä–µ–Ω–±—É—Ä–≥', '–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–û—Ä—ë–ª',
            '–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ü–µ–Ω–∑–∞', '–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ü—Å–∫–æ–≤',
            '–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–†—è–∑–∞–Ω—å',
            '–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–°–∞–º–∞—Ä–∞', '–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–°–∞—Ä–∞—Ç–æ–≤',
            '–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫', '–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
            '–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–°–º–æ–ª–µ–Ω—Å–∫', '–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–¢–∞–º–±–æ–≤',
            '–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–¢–≤–µ—Ä—å', '–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–¢–æ–º—Å–∫',
            '–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–¢—É–ª–∞', '–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–¢—é–º–µ–Ω—å',
            '–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–£–ª—å—è–Ω–æ–≤—Å–∫', '–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–ß–µ–ª—è–±–∏–Ω—Å–∫',
            '–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': '–Ø—Ä–æ—Å–ª–∞–≤–ª—å', '–ú–æ—Å–∫–≤–∞': '–ú–æ—Å–∫–≤–∞',
            '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å': '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å',
            '–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å': '–ë–∏—Ä–æ–±–∏–¥–∂–∞–Ω', '–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û': '–ù–∞—Ä—å—è–Ω-–ú–∞—Ä',
            '–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û': '–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫', '–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û': '–ê–Ω–∞–¥—ã—Ä—å',
            '–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û': '–°–∞–ª–µ—Ö–∞—Ä–¥'
        };

        const regionZones = {
            west: [
                '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–ú–∞—Ä–∏–π –≠–ª', '–ß—É–≤–∞—à–∏—è', '–ú–æ—Ä–¥–æ–≤–∏—è', '–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
            ],
            
            east: [
                '–°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)', '–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π', '–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π', '–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π',
                '–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û',
                '–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å', '–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π', '–ë—É—Ä—è—Ç–∏—è',
                '–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π', '–¢—ã–≤–∞', '–•–∞–∫–∞—Å–∏—è',
                '–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
                '–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π', '–ê–ª—Ç–∞–π', '–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
            ],
            
            north: [
                '–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö–∞—Ä–µ–ª–∏—è', '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û',
                '–ö–æ–º–∏', '–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û', '–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û',
                '–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π', '–£–¥–º—É—Ä—Ç–∏—è', '–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 
                '–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω', '–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω',
                '–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
                '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö–∞–ª–º—ã–∫–∏—è'
            ],
            
            south: [
                '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π', '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π', '–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
                '–ê–¥—ã–≥–µ—è', '–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è', '–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä–∏—è', '–°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è',
                '–ò–Ω–≥—É—à–µ—Ç–∏—è', '–ß–µ—á–Ω—è', '–î–∞–≥–µ—Å—Ç–∞–Ω', '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å',
                '–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
                '–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
            ]
        };

        const colorPalette = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#FAD7A0',
            '#D7BDE2', '#A3E4D7', '#F9E79F', '#FADBD8', '#D5F4E6',
            '#AED6F1', '#F5CBA7', '#E8DAEF', '#A9DFBF', '#FAE5D3',
            '#ABEBC6', '#F6DDCC', '#D5D8DC', '#E59866', '#76D7C4',
            '#F8BBD0', '#C5E1A5', '#FFE082', '#B39DDB', '#80CBC4',
            '#CE93D8', '#90CAF9', '#FFF59D', '#FFAB91', '#A5D6A7',
            '#81C784', '#64B5F6', '#4DB6AC', '#FFD54F', '#DCE775',
            '#BA68C8', '#9575CD', '#7986CB', '#4FC3F7', '#4DD0E1',
            '#26C6DA', '#26A69A', '#66BB6A', '#9CCC65', '#D4E157',
            '#FFEE58', '#FFCA28', '#FFA726', '#FF7043', '#8D6E63',
            '#BDBDBD', '#78909C', '#FF8A80', '#FF80AB', '#EA80FC',
            '#B388FF', '#8C9EFF', '#82B1FF', '#80D8FF', '#84FFFF',
            '#A7FFEB', '#B9F6CA', '#CCFF90', '#F4FF81', '#FFFF8D',
            '#FFE57F', '#FFD180', '#FF9E80', '#BCAAA4', '#B0BEC5',
            '#CFD8DC', '#FFCCBC', '#D7CCC8', '#F5F5F5', '#EEEEEE',
            '#E0E0E0', '#BDBDBD', '#9E9E9E', '#757575', '#616161'
        ];

        let currentLevel = 0;
        let currentRegion = null;
        let attempts = 0;
        let guessedRegions = [];
        let correctlyGuessed = 0;
        let missedRegions = 0;
        let studyModeActive = false;
        let gameStarted = false;
        let remainingRegions = [];
        let allRegions = [];
        let levelRegions = [];
        let svg, g, projection, path, zoom;
        let regionColors = {};
        let geoData = null;

        const levelSelector = document.getElementById('levelSelector');
        const gameContainer = document.getElementById('gameContainer');
        const startBtn = document.getElementById('startBtn');
        const studyModeBtn = document.getElementById('studyMode');
        const backToLevelsBtn = document.getElementById('backToLevels');
        const resetZoomBtn = document.getElementById('resetZoom');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const regionNameEl = document.getElementById('regionName');
        const attemptsEl = document.getElementById('attempts');
        const statsEl = document.getElementById('stats');
        const regionInfoEl = document.getElementById('regionInfo');
        const studyRegionNameEl = document.getElementById('studyRegionName');
        const studyRegionCapitalEl = document.getElementById('studyRegionCapital');
        const mapContainer = document.getElementById('mapContainer');
        const feedbackNotification = document.getElementById('feedbackNotification');
        const feedbackIcon = document.getElementById('feedbackIcon');
        const feedbackText = document.getElementById('feedbackText');
        const screenFlash = document.getElementById('screenFlash');
        const finalSummaryEl = document.getElementById('finalSummary');

        startBtn.addEventListener('click', startGame);
        studyModeBtn.addEventListener('click', toggleStudyMode);
        backToLevelsBtn.addEventListener('click', backToLevels);
        resetZoomBtn.addEventListener('click', () => centerOnLevel());
        zoomInBtn.addEventListener('click', zoomIn);
        zoomOutBtn.addEventListener('click', zoomOut);

        function selectLevel(level) {
            currentLevel = level;
            levelSelector.style.display = 'none';
            gameContainer.classList.add('active');
            
            if (geoData) {
                setupLevel();
            } else {
                loadMap();
            }
        }

        function setupLevel() {
            if (currentLevel === 5) {
                levelRegions = [...allRegions];
            } else {
                const zoneMap = ['west', 'east', 'north', 'south'];
                const zone = zoneMap[currentLevel - 1];
                levelRegions = regionZones[zone].filter(r => allRegions.includes(r));
            }
            
            remainingRegions = [...levelRegions];
            
            // –í–º–µ—Å—Ç–æ —Å–∫—Ä—ã—Ç–∏—è –¥–µ–ª–∞–µ–º —Ä–µ–≥–∏–æ–Ω—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ (—Å–µ—Ä—ã–º–∏)
            g.selectAll('.region-path').each(function() {
                const regionName = d3.select(this).attr('data-region');
                if (levelRegions.includes(regionName)) {
                    d3.select(this).classed('inactive', false);
                } else {
                    d3.select(this).classed('inactive', true);
                }
            });
            
            centerOnLevel();
            updateStats();
            regionNameEl.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å" –¥–ª—è –∏–≥—Ä—ã';
            attemptsEl.textContent = '';
        }

        function centerOnLevel() {
            if (!geoData || levelRegions.length === 0) return;

            if (currentLevel === 5) {
                svg.transition()
                    .duration(1000)
                    .call(zoom.transform, d3.zoomIdentity);
                return;
            }

            const levelFeatures = geoData.features.filter(f => 
                levelRegions.includes(f.properties.name)
            );

            if (levelFeatures.length === 0) return;

            let minX = Infinity, minY = Infinity;
            let maxX = -Infinity, maxY = -Infinity;

            levelFeatures.forEach(feature => {
                const bounds = path.bounds(feature);
                minX = Math.min(minX, bounds[0][0]);
                minY = Math.min(minY, bounds[0][1]);
                maxX = Math.max(maxX, bounds[1][0]);
                maxY = Math.max(maxY, bounds[1][1]);
            });

            const dx = maxX - minX;
            const dy = maxY - minY;
            const x = (minX + maxX) / 2;
            const y = (minY + maxY) / 2;
            
            const scale = Math.min(8, 0.85 / Math.max(dx / 1200, dy / 700));
            const translate = [1200 / 2 - scale * x, 700 / 2 - scale * y];

            svg.transition()
                .duration(1000)
                .call(
                    zoom.transform,
                    d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
                );
        }

        function backToLevels() {
            gameContainer.classList.remove('active');
            levelSelector.style.display = 'block';
            resetGame();
        }

        async function loadMap() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/russia.geojson');
                
                if (!response.ok) {
                    throw new Error('HTTP error status: ' + response.status);
                }
                
                geoData = await response.json();

                allRegions = geoData.features
                    .map(f => f.properties.name)
                    .filter(name => name);

                allRegions.forEach((region, index) => {
                    regionColors[region] = colorPalette[index % colorPalette.length];
                });

                const width = 1200;
                const height = 700;

                projection = d3.geoMercator()
                    .center([100, 65])
                    .scale(350)
                    .translate([width / 2, height / 2 + 60]);

                path = d3.geoPath().projection(projection);

                svg = d3.select("#map")
                    .html('')
                    .append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", '0 0 ' + width + ' ' + height);

                g = svg.append("g");

                zoom = d3.zoom()
                    .scaleExtent([1, 8])
                    .translateExtent([[0, 0], [width, height]])
                    .filter(function(event) {
                        return event.type !== 'wheel';
                    })
                    .on("zoom", function(event) {
                        g.attr("transform", event.transform);
                    });

                svg.call(zoom);

                g.selectAll(".region-path")
                    .data(geoData.features)
                    .enter()
                    .append("path")
                    .attr("class", "region-path")
                    .attr("d", path)
                    .attr("data-region", function(d) { return d.properties.name; })
                    .style("fill", function(d) { return regionColors[d.properties.name] || '#e8e8ed'; })
                    .on("click", function(event, d) {
                        event.stopPropagation();
                        handleRegionClick(this, d.properties.name);
                    });

                setupLevel();
                console.log('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –í—Å–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–æ–≤:', allRegions.length);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:', error);
                document.getElementById('map').innerHTML = 
                    '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</div>';
            }
        }

        function zoomToRegion(regionName) {
            const regionFeature = geoData.features.find(f => f.properties.name === regionName);
            if (!regionFeature) return;

            const bounds = path.bounds(regionFeature);
            const dx = bounds[1][0] - bounds[0][0];
            const dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2;
            const y = (bounds[0][1] + bounds[1][1]) / 2;
            const scale = Math.min(8, 0.9 / Math.max(dx / 1200, dy / 700));
            const translate = [1200 / 2 - scale * x, 700 / 2 - scale * y];

            svg.transition()
                .duration(750)
                .call(
                    zoom.transform,
                    d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
                );

            setTimeout(function() {
                centerOnLevel();
            }, 1500);
        }

        function showFeedback(isCorrect) {
            feedbackNotification.classList.remove('show', 'correct', 'incorrect');
            screenFlash.classList.remove('show', 'correct', 'incorrect');
            
            if (isCorrect) {
                feedbackIcon.textContent = '‚úì';
                feedbackText.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                feedbackNotification.classList.add('correct');
                screenFlash.classList.add('correct');
            } else {
                feedbackIcon.textContent = '‚úó';
                feedbackText.textContent = '–ù–µ–≤–µ—Ä–Ω–æ!';
                feedbackNotification.classList.add('incorrect');
                screenFlash.classList.add('incorrect');
            }
            
            setTimeout(function() {
                feedbackNotification.classList.add('show');
                screenFlash.classList.add('show');
            }, 10);
            
            setTimeout(function() {
                feedbackNotification.classList.remove('show');
                screenFlash.classList.remove('show');
            }, 500);
        }

        function flashBorder(isCorrect) {
            mapContainer.classList.remove('correct', 'incorrect');
            void mapContainer.offsetWidth;
            mapContainer.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            setTimeout(function() {
                mapContainer.classList.remove('correct', 'incorrect');
            }, 500);
        }

        function showFinalSummary() {
            const total = levelRegions.length;
            const percentage = Math.round((correctlyGuessed / total) * 100);
            
            let percentageClass = 'needwork';
            let message = '–ü—Ä–æ–¥–æ–ª–∂–∞–π –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!';
            
            if (percentage >= 90) {
                percentageClass = 'excellent';
                message = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üéâ';
            } else if (percentage >= 70) {
                percentageClass = 'good';
                message = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üëç';
            }

            finalSummaryEl.innerHTML = `
                <div class="final-summary">
                    <h2>üéä –£—Ä–æ–≤–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
                    <div class="summary-stats">
                        <div class="stat-item correct-stat">
                            <div class="stat-number">${correctlyGuessed}</div>
                            <div class="stat-label">–£–≥–∞–¥–∞–Ω–æ</div>
                        </div>
                        <div class="stat-item missed-stat">
                            <div class="stat-number">${missedRegions}</div>
                            <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                        </div>
                        <div class="stat-item total-stat">
                            <div class="stat-number">${total}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ</div>
                        </div>
                    </div>
                    <div class="percentage ${percentageClass}">
                        –¢–æ—á–Ω–æ—Å—Ç—å: ${percentage}%
                    </div>
                    <p style="margin-top: 12px; font-size: 18px; color: #666;">${message}</p>
                </div>
            `;
        }

        function toggleStudyMode() {
            studyModeActive = !studyModeActive;
            
            if (studyModeActive) {
                studyModeBtn.textContent = '–í—ã–π—Ç–∏ –∏–∑ –∏–∑—É—á–µ–Ω–∏—è';
                studyModeBtn.classList.add('active');
                startBtn.disabled = true;
                regionInfoEl.classList.add('visible');
                
                if (gameStarted) {
                    gameStarted = false;
                    currentRegion = null;
                    regionNameEl.textContent = '–†–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è';
                    attemptsEl.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ä–µ–≥–∏–æ–Ω';
                }
            } else {
                studyModeBtn.textContent = '–†–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è';
                studyModeBtn.classList.remove('active');
                startBtn.disabled = false;
                regionInfoEl.classList.remove('visible');
                
                g.selectAll('.region-path.studying').classed('studying', false);
                regionNameEl.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å"';
                attemptsEl.textContent = '';
            }
        }

        function nextRegion() {
            if (remainingRegions.length === 0) {
                gameStarted = false;
                regionNameEl.textContent = 'üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!';
                attemptsEl.textContent = '';
                startBtn.disabled = false;
                showFinalSummary();
                return;
            }

            const randomIndex = Math.floor(Math.random() * remainingRegions.length);
            currentRegion = remainingRegions[randomIndex];
            attempts = 3;
            
            regionNameEl.textContent = currentRegion;
            attemptsEl.textContent = '–ü–æ–ø—ã—Ç–æ–∫: ' + attempts;
            updateStats();
        }

        function handleRegionClick(element, clickedRegion) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–≥–∏–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ
            if (!levelRegions.includes(clickedRegion)) return;
            
            if (studyModeActive) {
                g.selectAll('.region-path.studying').classed('studying', false);
                d3.select(element).classed('studying', true);
                
                studyRegionNameEl.textContent = clickedRegion;
                const capital = regionCapitals[clickedRegion] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                studyRegionCapitalEl.textContent = '–°—Ç–æ–ª–∏—Ü–∞: ' + capital;
                
            } else if (gameStarted && currentRegion) {
                const regionElement = d3.select(element);
                
                if (guessedRegions.includes(clickedRegion)) {
                    return;
                }

                if (clickedRegion === currentRegion) {
                    showFeedback(true);
                    flashBorder(true);
                    regionElement.classed('guessed', true);
                    guessedRegions.push(currentRegion);
                    correctlyGuessed++;
                    remainingRegions = remainingRegions.filter(function(r) { return r !== currentRegion; });
                    
                    setTimeout(function() {
                        nextRegion();
                    }, 600);
                    
                } else {
                    showFeedback(false);
                    flashBorder(false);
                    attempts--;
                    attemptsEl.textContent = '–ü–æ–ø—ã—Ç–æ–∫: ' + attempts;

                    if (attempts === 0) {
                        g.selectAll('.region-path')
                            .filter(function() {
                                return d3.select(this).attr('data-region') === currentRegion;
                            })
                            .classed('missed', true);
                        
                        missedRegions++;
                        guessedRegions.push(currentRegion);
                        remainingRegions = remainingRegions.filter(function(r) { return r !== currentRegion; });
                        
                        zoomToRegion(currentRegion);
                        
                        setTimeout(function() {
                            g.selectAll('.region-path.missed')
                                .classed('missed', false)
                                .classed('guessed', true);
                            
                            nextRegion();
                        }, 3000);
                    }
                }
            }
        }

        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        }

        function startGame() {
            if (studyModeActive) {
                alert('–í—ã–π–¥–∏—Ç–µ –∏–∑ —Ä–µ–∂–∏–º–∞ –∏–∑—É—á–µ–Ω–∏—è!');
                return;
            }

            gameStarted = true;
            startBtn.disabled = true;
            guessedRegions = [];
            correctlyGuessed = 0;
            missedRegions = 0;
            remainingRegions = [...levelRegions];
            finalSummaryEl.innerHTML = '';
            
            g.selectAll('.region-path')
                .classed('guessed', false)
                .classed('missed', false)
                .style('fill', function() {
                    const region = d3.select(this).attr('data-region');
                    return regionColors[region] || '#e8e8ed';
                });
            
            nextRegion();
        }

        function resetGame() {
            currentRegion = null;
            attempts = 0;
            guessedRegions = [];
            correctlyGuessed = 0;
            missedRegions = 0;
            gameStarted = false;
            startBtn.disabled = false;
            finalSummaryEl.innerHTML = '';
            
            if (geoData) {
                remainingRegions = [...levelRegions];
                
                g.selectAll('.region-path')
                    .classed('guessed', false)
                    .classed('missed', false)
                    .classed('studying', false)
                    .style('fill', function() {
                        const region = d3.select(this).attr('data-region');
                        return regionColors[region] || '#e8e8ed';
                    });
            }

            if (studyModeActive) {
                regionNameEl.textContent = '–†–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è';
                attemptsEl.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ä–µ–≥–∏–æ–Ω';
                studyRegionNameEl.textContent = '‚Äî';
                studyRegionCapitalEl.textContent = '‚Äî';
            } else {
                regionNameEl.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å"';
                attemptsEl.textContent = '';
            }
            
            updateStats();
        }

        function updateStats() {
            const total = levelRegions.length;
            const completed = guessedRegions.length;
            const remaining = remainingRegions.length;
            
            statsEl.textContent = '–ü—Ä–æ–π–¥–µ–Ω–æ: ' + completed + ' –∏–∑ ' + total + ' | –û—Å—Ç–∞–ª–æ—Å—å: ' + remaining;
        }
    </script>
</body>
</html>
